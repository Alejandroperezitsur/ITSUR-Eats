# ðŸ”– v4.0.0 â€” Analytics & Intelligence

**Fecha de Lanzamiento Objetivo**: Mes 9 (8 semanas despuÃ©s de v3)
**DuraciÃ³n del Sprint**: 8 semanas
**Dependencias**: v3.0.0 completado con 5,000+ usuarios

---

## ðŸŽ¯ Objetivo de la VersiÃ³n

Transformar datos en inteligencia de negocio. Esta versiÃ³n implementa analytics avanzados, machine learning para predicciÃ³n de demanda, reportes ejecutivos y frameworks A/B testing. Habilita decisiones basadas en datos y optimizaciÃ³n continua del negocio.

### Problemas Resueltos
- âŒ Sin visibilidad de tendencias â†’ âœ… Analytics dashboard
- âŒ Sorpresas en demanda â†’ âœ… PredicciÃ³n ML
- âŒ Sin segmentaciÃ³n de clientes â†’ âœ… Cohort analysis
- âŒ Decisiones sin datos â†’ âœ… Data-driven insights

### Habilita
- OptimizaciÃ³n de menÃº basada en datos
- PredicciÃ³n de demanda horaria
- IdentificaciÃ³n de clientes de alto valor
- Estrategias de retenciÃ³n basadas en segmentos
- Decisiones operativas mÃ¡s inteligentes

---

## ðŸ§© Funcionalidades Incluidas

### Dashboard Analytics (Admin Panel)

#### Overview Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ITSUR Eats - Dashboard AnalÃ­tico | Enero 2026          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚
â”‚ ðŸ“Š RESUMEN EJECUTIVO (Ãšltimos 7 dÃ­as)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ Ingresos Totales: $15,750 MXN â”‚ â†‘ 12% vs sem anterior
â”‚ â”‚ Ã“rdenes: 425                   â”‚ â†‘ 8% vs sem anterior
â”‚ â”‚ Ticket Promedio: $37.06        â”‚ â†‘ 3% vs sem anterior
â”‚ â”‚ Usuarios Activos: 1,200        â”‚ â†‘ 15% vs sem anterior
â”‚ â”‚ Tasa ConversiÃ³n: 68%           â”‚ â†‘ 2% vs sem anterior
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚ ðŸ“ˆ GRÃFICOS EN TIEMPO REAL
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ Ingresos (7d)    â”‚  â”‚ Ã“rdenes/Hora     â”‚
â”‚ â”‚ [GrÃ¡fico lÃ­nea]  â”‚  â”‚ [GrÃ¡fico barras] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚ ðŸ† TOP PRODUCTOS          ðŸŽ¯ TOP USUARIOS
â”‚ 1. Burrito Deluxe   $2.1K â”‚ 1. Juan P.    12 Ã³rdenes
â”‚ 2. Tacos Carne      $1.8K â”‚ 2. MarÃ­a G.   10 Ã³rdenes
â”‚ 3. Enchiladas      $1.6K â”‚ 3. Carlos V.   8 Ã³rdenes
â”‚
â”‚ [Descargar Reporte] [Exportar CSV] [Configurar Alertas]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PredicciÃ³n de Demanda

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Predictor de Demanda (ML)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚
â”‚ ðŸ“… Hoy - PrÃ³ximas 8 horas
â”‚
â”‚ Hora     â”‚ PredicciÃ³n â”‚ Confianza â”‚ RecomendaciÃ³n
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ 12:00    â”‚ 45 Ã³rdenes â”‚ 92%       â”‚ âœ… Normal
â”‚ 12:30    â”‚ 62 Ã³rdenes â”‚ 88%       â”‚ âš ï¸ Prepare +20%
â”‚ 13:00    â”‚ 78 Ã³rdenes â”‚ 85%       â”‚ ðŸ”´ Pico esperado
â”‚ 13:30    â”‚ 64 Ã³rdenes â”‚ 89%       â”‚ âš ï¸ Prepare +15%
â”‚ 14:00    â”‚ 38 Ã³rdenes â”‚ 91%       â”‚ âœ… Normal
â”‚
â”‚ [Ver Modelo] [Historial PrecisiÃ³n] [Retrain Model]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Algoritmo ML:**
```
Features de entrada:
- Hora del dÃ­a
- DÃ­a de la semana
- Fecha (fin de mes = mÃ¡s dinero)
- Clima
- Eventos especiales (exÃ¡menes finales)
- HistÃ³rico de Ãºltimas 12 semanas
- Tendencias de productos

Target:
- Cantidad de Ã³rdenes esperadas

Modelo: LightGBM (optimizado para predicciÃ³n)
Accuracy: 85-90%
Reentrenamiento: Diario a las 23:00
```

#### Cohort Analysis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnÃ¡lisis de Cohortes (RetenciÃ³n de Usuarios)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚
â”‚ Cohorte de Registro | Semana 0 | Sem 1 | Sem 2 | Sem 4
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Enero 1-7           â”‚ 100%    â”‚ 68%  â”‚ 52%  â”‚ 38%
â”‚ Enero 8-14          â”‚ 100%    â”‚ 72%  â”‚ 58%  â”‚ 45%
â”‚ Enero 15-21         â”‚ 100%    â”‚ 70%  â”‚ 54%  â”‚ 41%
â”‚
â”‚ ðŸ“Š Insight: RetenciÃ³n mejorando 2-3% semana a semana
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### SegmentaciÃ³n de Usuarios

```
Segmentos automÃ¡ticos:
â”Œâ”€ VIP Users (Top 10%)
â”‚  â”œâ”€ Criterios: > 15 Ã³rdenes/mes, avg spend > $50
â”‚  â”œâ”€ Count: 120 usuarios
â”‚  â”œâ”€ Revenue: 35% de total
â”‚  â””â”€ AcciÃ³n: Programa de lealtad exclusivo
â”‚
â”œâ”€ Regular Users (60%)
â”‚  â”œâ”€ Criterios: 3-15 Ã³rdenes/mes
â”‚  â”œâ”€ Count: 720 usuarios
â”‚  â”œâ”€ Revenue: 55% de total
â”‚  â””â”€ AcciÃ³n: Promociones personalizadas
â”‚
â””â”€ At-Risk Users (30%)
   â”œâ”€ Criterios: < 3 Ã³rdenes/mes Ãºltimas 4 semanas
   â”œâ”€ Count: 360 usuarios
   â”œâ”€ Revenue: 10% de total
   â””â”€ AcciÃ³n: Re-engagement campaigns
```

#### Customer Lifetime Value (CLV)

```
CÃ¡lculo de CLV:
CLV = (Avg Order Value) Ã— (Purchase Frequency) Ã— (Customer Lifetime)

Ejemplo:
- Avg Order Value: $37
- Purchase Frequency: 2.5 Ã³rdenes/mes
- Expected Lifetime: 18 meses (1.5 aÃ±os)

CLV = $37 Ã— 2.5 Ã— 18 = $1,665 por usuario

Top 10% CLV: > $3,500
Bottom 30% CLV: < $500
```

### Reportes Avanzados

#### Reporte de Negocio (Semanal)

```
ITSUR Eats - Reporte Semanal
Semana del 16-22 de Enero de 2026

ðŸ“Š FINANCIERO
- Ingresos: $15,750 MXN (+12%)
- Costo de Goods Sold: $6,300 MXN (40%)
- Utilidad Bruta: $9,450 MXN (60%)
- Gastos Operacionales: $2,000 MXN (13%)
- EBITDA: $7,450 MXN (47%)

ðŸ“ˆ OPERACIONAL
- Ã“rdenes: 425 (+8%)
- Promedio por DÃ­a: 60.7 Ã³rdenes
- Ticket Promedio: $37.06 (+3%)
- Tasa de AceptaciÃ³n: 98.5%
- Tiempo Promedio de PreparaciÃ³n: 8.2 minutos

ðŸ‘¥ USUARIOS
- Nuevos Registros: 85 (+22%)
- Usuarios Activos: 1,200 (+15%)
- Tasa de RetenciÃ³n DÃ­a 7: 72%
- NPS Score: 68 (+5 puntos)

âš ï¸ PROBLEMAS IDENTIFICADOS
1. 3 cancelaciones por "Sin disponibilidad" el lunes
   â†’ AcciÃ³n: Aumentar pronÃ³stico de demanda

2. 2 reclamaciones por demora en preparaciÃ³n
   â†’ AcciÃ³n: Revisar staffing en horas pico

3. Baja adopciÃ³n de wallet (22%)
   â†’ AcciÃ³n: Promover mediante incentivos

âœ… RECOMENDACIONES
1. Lanzar promociÃ³n de "Happy Hour" 12-13hrs (predicciÃ³n de pico)
2. Agregar 2 productos similares a "Burrito Deluxe" (top 1)
3. Iniciar programa VIP para usuarios top 10%
4. Retrain modelo de predicciÃ³n con Ãºltimos 7 dÃ­as
```

#### Reporte de Productos

```
ANÃLISIS DE PRODUCTOS
Top 10 por Ingresos:

Rank â”‚ Producto        â”‚ Units â”‚ Ingresos â”‚ Margin â”‚ Velocidad
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1    â”‚ Burrito Deluxe  â”‚ 57    â”‚ $2,140   â”‚ 62%    â”‚ âš¡âš¡âš¡
2    â”‚ Tacos Carne     â”‚ 48    â”‚ $1,800   â”‚ 65%    â”‚ âš¡âš¡âš¡
3    â”‚ Enchiladas      â”‚ 43    â”‚ $1,590   â”‚ 60%    â”‚ âš¡âš¡
4    â”‚ Torta Mixta     â”‚ 38    â”‚ $1,425   â”‚ 68%    â”‚ âš¡âš¡
5    â”‚ Quesadillas     â”‚ 35    â”‚ $1,295   â”‚ 70%    â”‚ âš¡

Productos con Baja RotaciÃ³n (Considerar discontinuar):
- Ensalada Caesar: 2 units/semana
- Sopa del DÃ­a: 3 units/semana
```

### A/B Testing Framework

#### Feature: Llamar en lugar de NotificaciÃ³n Push

```
Experimento A/B:

Control (A): NotificaciÃ³n push "Tu pedido estÃ¡ listo"
Variante (B): Llamada telefÃ³nica automÃ¡tica + push

DuraciÃ³n: 2 semanas
Muestra: 200 usuarios por grupo (random)

MÃ©tricas:
- Click-through rate
- Pickup time
- Customer satisfaction

Resultados:
- Control: 65% open rate, 8min avg pickup
- Variante: 82% open rate, 5min avg pickup
- Winner: Variante B (estadÃ­sticamente significante, p < 0.05)
- RecomendaciÃ³n: Implementar para todos
```

#### ConfiguraciÃ³n de Experimentos

```typescript
@Post('/admin/experiments')
async createExperiment(
  @Body() dto: {
    name: string;
    description: string;
    hypothesis: string;
    duration_days: number;
    metrics: string[];
    variant_a: any;
    variant_b: any;
  }
) {
  // Crear experimento
  const experiment = await this.experimentsService.create(dto);

  // Asignar usuarios aleatoriamente
  const users = await this.usersService.getActiveUsers();
  const half = Math.ceil(users.length / 2);
  
  for (let i = 0; i < users.length; i++) {
    await this.experimentService.assignUser(
      users[i].id,
      i < half ? 'A' : 'B',
      experiment.id
    );
  }

  return experiment;
}

@Get('/admin/experiments/:id/results')
async getResults(@Param('id') experimentId: string) {
  const experiment = await this.experimentsService.getOne(experimentId);
  const results = await this.analyticsService.analyzeExperiment(experimentId);
  
  // Statistical significance test
  const pValue = this.calculatePValue(results.variantA, results.variantB);
  
  return {
    experiment,
    results,
    isSignificant: pValue < 0.05,
    winner: this.determineWinner(results, pValue)
  };
}
```

### Machine Learning Pipeline

#### Demand Forecasting

```python
# Data pipeline
from sklearn.ensemble import LGBMRegressor
import pandas as pd

class DemandForecaster:
    def __init__(self):
        self.model = LGBMRegressor(
            num_leaves=31,
            learning_rate=0.05,
            n_estimators=100
        )
    
    def prepare_features(self, df):
        """Preparar features"""
        df['hour'] = df['timestamp'].dt.hour
        df['dayofweek'] = df['timestamp'].dt.dayofweek
        df['is_weekend'] = df['dayofweek'].isin([5, 6]).astype(int)
        df['is_payday'] = (df['timestamp'].dt.day >= 15).astype(int)
        
        # Lag features (histÃ³rico)
        df['orders_prev_hour'] = df['orders'].shift(1)
        df['orders_prev_day'] = df['orders'].shift(24)
        df['orders_prev_week'] = df['orders'].shift(168)
        
        return df[['hour', 'dayofweek', 'is_weekend', 'is_payday', 
                   'orders_prev_hour', 'orders_prev_day', 'orders_prev_week']]
    
    def train(self, df):
        """Entrenar modelo"""
        X = self.prepare_features(df)
        y = df['orders']
        
        self.model.fit(X, y)
        
        # ValidaciÃ³n
        score = self.model.score(X, y)
        print(f"RÂ² Score: {score:.3f}")
    
    def predict(self, hours_ahead=8):
        """Predecir prÃ³ximas horas"""
        predictions = []
        
        for i in range(hours_ahead):
            # Preparar features para prÃ³xima hora
            features = self.prepare_next_hour_features(i)
            pred = self.model.predict([features])[0]
            predictions.append({
                'hour': (datetime.now() + timedelta(hours=i)).hour,
                'predicted_orders': int(pred),
                'confidence': self.get_confidence(pred)
            })
        
        return predictions
    
    def get_confidence(self, prediction):
        """Calcular confidence score"""
        # Basado en variabilidad del modelo
        return min(95, max(50, 70 + (50 - prediction) * 0.5))

# Reentrenamiento diario
scheduler.add_job(forecaster.train, 'cron', hour=23, minute=0)
```

#### Churn Prediction

```python
class ChurnPredictor:
    def __init__(self):
        self.model = RandomForestClassifier(n_estimators=100)
    
    def calculate_churn_risk(self, user_id):
        """Calcular riesgo de churn para usuario"""
        user_data = self.get_user_metrics(user_id)
        
        features = {
            'days_since_last_order': user_data['days_since_last_order'],
            'avg_order_value': user_data['avg_order_value'],
            'order_frequency': user_data['order_frequency'],
            'satisfaction_score': user_data['satisfaction_score'],
            'account_age_days': user_data['account_age_days']
        }
        
        churn_probability = self.model.predict_proba([features.values()])[0][1]
        
        return {
            'user_id': user_id,
            'churn_risk': churn_probability,
            'segment': self.segment_churn_risk(churn_probability)
        }
    
    def segment_churn_risk(self, probability):
        if probability > 0.7:
            return 'HIGH_RISK'
        elif probability > 0.4:
            return 'MEDIUM_RISK'
        else:
            return 'LOW_RISK'
```

### IntegraciÃ³n de Datos

#### Event Tracking

```typescript
// Cada acciÃ³n importante se registra
class AnalyticsService {
  async trackEvent(userId: string, event: {
    type: 'ORDER_CREATED' | 'ORDER_COMPLETED' | 'PAYMENT_FAILED' | 'PROMO_VIEWED';
    properties: Record<string, any>;
  }) {
    await this.eventsRepository.create({
      userId,
      type: event.type,
      properties: event.properties,
      timestamp: new Date(),
      userAgent: this.req.headers['user-agent'],
      ipAddress: this.req.ip
    });
  }

  // En cada endpoint importante
  @Post('/orders')
  createOrder(@Body() dto: CreateOrderDto) {
    const order = await this.ordersService.create(dto);
    
    await this.analyticsService.trackEvent(user.id, {
      type: 'ORDER_CREATED',
      properties: {
        orderId: order.id,
        totalAmount: order.totalAmount,
        itemCount: order.items.length
      }
    });
    
    return order;
  }
}
```

#### Data Warehouse

```sql
-- Hecho central: Ã“rdenes
CREATE TABLE fact_orders (
  order_key INT PRIMARY KEY,
  order_id UUID,
  user_key INT,
  date_key INT,
  time_key INT,
  product_category_key INT,
  total_amount DECIMAL,
  payment_method VARCHAR,
  order_status VARCHAR,
  preparation_time INT
);

-- Dimensiones
CREATE TABLE dim_users (
  user_key INT PRIMARY KEY,
  user_id UUID,
  email VARCHAR,
  department VARCHAR,
  registration_date DATE,
  cohort_month INT
);

CREATE TABLE dim_dates (
  date_key INT PRIMARY KEY,
  date DATE,
  year INT,
  month INT,
  day INT,
  quarter INT,
  is_weekend BOOLEAN,
  day_name VARCHAR
);
```

---

## ðŸ—ï¸ Arquitectura TÃ©cnica (v4)

### Analytics Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Analytics Platform             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Mobile/Web Apps & Admin Panel        â”‚
â”‚         (Events Tracking)              â”‚
â”‚              â†“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Event Collection Service   â”‚      â”‚
â”‚  â”‚  (NestJS + Redis Queue)     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚               â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Data Lake (S3)             â”‚      â”‚
â”‚  â”‚  - Raw events               â”‚      â”‚
â”‚  â”‚  - Backups                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚               â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Data Warehouse             â”‚      â”‚
â”‚  â”‚  (PostgreSQL)               â”‚      â”‚
â”‚  â”‚  - Fact tables              â”‚      â”‚
â”‚  â”‚  - Dimensions               â”‚      â”‚
â”‚  â”‚  - Aggregates               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚               â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Analytics Engine (Python)        â”‚â”‚
â”‚  â”‚  - ML Models                      â”‚â”‚
â”‚  â”‚  - Predictive Analytics           â”‚â”‚
â”‚  â”‚  - Cohort Analysis                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â†“                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Visualization Layer               â”‚
â”‚  â”‚  - Dashboard React                 â”‚
â”‚  â”‚  - Reports PDF                     â”‚
â”‚  â”‚  - Exports CSV/Excel               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ML Pipeline Deployment

```yaml
# Python service para ML
kind: Deployment
metadata:
  name: ml-service
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: ml-service
        image: itsur-ml-service:v4
        ports:
        - containerPort: 5000
        env:
        - name: MODEL_PATH
          value: "/models"
        volumeMounts:
        - name: models
          mountPath: /models
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 60
          periodSeconds: 30
      volumes:
      - name: models
        persistentVolumeClaim:
          claimName: ml-models-pvc
```

### Database Schema para Analytics

```sql
-- Eventos rastreados
CREATE TABLE events (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  event_type VARCHAR NOT NULL,
  properties JSONB,
  timestamp TIMESTAMP DEFAULT NOW(),
  user_agent VARCHAR,
  ip_address VARCHAR
);

-- MÃ©tricas agregadas (para optimizaciÃ³n)
CREATE TABLE daily_metrics (
  date DATE PRIMARY KEY,
  total_orders INT,
  total_revenue DECIMAL(10,2),
  unique_users INT,
  avg_order_value DECIMAL(10,2),
  conversion_rate FLOAT,
  churn_rate FLOAT
);

-- Predicciones guardadas
CREATE TABLE demand_predictions (
  id UUID PRIMARY KEY,
  prediction_date DATE,
  hour INT,
  predicted_orders INT,
  confidence FLOAT,
  actual_orders INT,
  created_at TIMESTAMP
);

-- Experimentos
CREATE TABLE experiments (
  id UUID PRIMARY KEY,
  name VARCHAR NOT NULL,
  hypothesis TEXT,
  status ENUM ('DRAFT', 'RUNNING', 'COMPLETED') DEFAULT 'DRAFT',
  start_date TIMESTAMP,
  end_date TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE experiment_assignments (
  id UUID PRIMARY KEY,
  experiment_id UUID REFERENCES experiments(id),
  user_id UUID REFERENCES users(id),
  variant ENUM ('A', 'B'),
  assigned_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE experiment_metrics (
  id UUID PRIMARY KEY,
  experiment_id UUID REFERENCES experiments(id),
  user_id UUID REFERENCES users(id),
  variant ENUM ('A', 'B'),
  metric_name VARCHAR,
  metric_value FLOAT,
  recorded_at TIMESTAMP DEFAULT NOW()
);
```

---

## ðŸ“Š KPIs & Ã‰xito de v4

| KPI | Target | MÃ©trica |
|-----|--------|---------|
| Prediction Accuracy | > 85% | MAPE en predicciones |
| Data Quality | > 95% | Eventos con datos completos |
| Dashboard Uptime | 99.9% | Disponibilidad analytics |
| Report Generation | < 5s | Tiempo de procesamiento |
| Churn Detection | 80% recall | Usuarios en riesgo predichos |
| A/B Test Setup Time | < 2 hours | Tiempo para lanzar experimento |

---

## ðŸš€ PreparaciÃ³n para ProducciÃ³n en v4

### Privacy & GDPR Compliance

```typescript
// Los datos deben ser anÃ³nimizados
const eventToStore = {
  // âœ… OK: Event type (anÃ³nimo)
  event_type: 'ORDER_CREATED',
  // âœ… OK: Agregado
  total_amount: 45.50,
  // âŒ NO: InformaciÃ³n personal
  // user_name: 'Juan PÃ©rez'
  // âŒ NO: ID directo (si estÃ¡ en eventos pÃºblicos)
  // user_id: 'user_123'
};

// Para anÃ¡lisis especÃ­ficos de usuario:
// - Usar hashed user ID o PII-safe identifier
// - Mantener separado de otros eventos
// - Implementar data minimization
```

### Data Retention Policy

```
Event Log:
- Raw events: 90 dÃ­as
- Aggregated metrics: 2 aÃ±os

ML Models:
- Training data: 12 meses (rolling window)
- Model artifacts: Indefinido (con versionado)

Experiments:
- Raw data: 30 dÃ­as post-conclusiÃ³n
- Results summary: 2 aÃ±os

Compliance:
- AuditorÃ­a logs: 1 aÃ±o
- Backup: 30 dÃ­as (incremental)
```

---

## ðŸ“ Entregables de v4

```
âœ… Analytics Dashboard
   - Componentes React
   - Websockets para updates
   - Export capabilities

âœ… ML Models
   - Demand forecasting
   - Churn prediction
   - Customer segmentation

âœ… A/B Testing Platform
   - Experiment management
   - Statistical analysis
   - Results visualization

âœ… Reports System
   - Weekly reports automÃ¡ticos
   - Ad-hoc report builder
   - PDF export

âœ… Data Infrastructure
   - Data warehouse setup
   - ETL pipelines
   - Data quality monitoring

âœ… Documentation
   - Analytics API
   - ML model guides
   - Data dictionary
```

---

## ðŸ“Œ Siguiente Fase (v5.0.0)

â†’ **v5.0.0 â€” Institutional Expansion**

Con datos sÃ³lidos y sistema estable:
- Multi-campus support
- SSO integraciÃ³n (ITSUR central)
- CustomizaciÃ³n por instituciÃ³n
- LocalizaciÃ³n multiidioma
- API para partners

**Estimado**: 8 semanas despuÃ©s de v4

---

**Documento creado**: 20 Enero 2026
**Estado**: EspecificaciÃ³n TÃ©cnica Completa
**ML Accuracy Target**: > 85% MAE en predicciones
