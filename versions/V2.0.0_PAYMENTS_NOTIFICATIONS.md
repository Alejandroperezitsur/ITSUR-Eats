# üîñ v2.0.0 ‚Äî Payments & Notifications

**Fecha de Lanzamiento Objetivo**: Mes 4 (8 semanas despu√©s de v1)
**Duraci√≥n del Sprint**: 8 semanas
**Dependencias**: v1.0.0 completado

---

## üéØ Objetivo de la Versi√≥n

Introducir un sistema de pagos robusto e integrado con notificaciones en tiempo real. Esta versi√≥n monetiza la plataforma, permite a usuarios pagar con tarjeta y efectivo con seguridad PCI-DSS, adem√°s de implementar un sistema de notificaciones push avanzado que mantiene a usuarios y admin conectados.

### Problemas Resueltos
- ‚ùå Sin forma de pago integrada (manual) ‚Üí ‚úÖ Pagos autom√°ticos
- ‚ùå Transacciones inseguras ‚Üí ‚úÖ PCI-DSS compliance
- ‚ùå Sin confirmaci√≥n de pedidos ‚Üí ‚úÖ Notificaciones push en tiempo real
- ‚ùå Admin sin alertas ‚Üí ‚úÖ Alertas inteligentes por urgencia

### Habilita
- Ciclo de ingresos autom√°tico
- Reducci√≥n de fraude
- Engagement mejorado de usuarios
- Datos de conversi√≥n m√°s precisos
- Soporte 24/7 mediante notificaciones

---

## üß© Funcionalidades Incluidas

### App Estudiante/Profesor (Mobile)

#### Sistema de Pagos

**M√©todos de Pago:**
- ‚úÖ Tarjeta de cr√©dito/d√©bito (Visa, Mastercard, American Express)
- ‚úÖ Pago en efectivo (comprobante de pago digital)
- ‚úÖ Wallet digital (saldo prepagado)
- ‚úÖ QR codes para pagos r√°pidos

**Gesti√≥n de M√©todos de Pago:**
- ‚úÖ Guardar m√∫ltiples tarjetas
- ‚úÖ Establecer tarjeta predeterminada
- ‚úÖ Eliminar tarjetas guardadas
- ‚úÖ Actualizar informaci√≥n de tarjeta
- ‚úÖ 3D Secure para transacciones seguras

**Pantalla de Pago:**
```
1. Resumen del pedido
   - Subtotal
   - Impuestos (IVA 16%)
   - Cargos por servicio (0%)
   - Total

2. Seleccionar m√©todo:
   - Tarjeta guardada (con √∫ltimo d√≠gito)
   - Agregar nueva tarjeta
   - Pagar en efectivo
   - Saldo wallet

3. Si tarjeta nueva:
   - N√∫mero de tarjeta
   - Fecha de expiraci√≥n
   - CVV
   - Nombre del titular
   - Guardar tarjeta para pr√≥ximas compras

4. Bot√≥n "Procesar Pago"
   - Loader animado
   - Confirmaci√≥n de √©xito o error
```

**Wallet Digital:**
- ‚úÖ Agregar saldo con tarjeta
- ‚úÖ M√≠nimo $100 MXN, m√°ximo $5,000 MXN
- ‚úÖ Ver historial de recargas
- ‚úÖ Saldo siempre visible en header
- ‚úÖ Reembolsos autom√°ticos al wallet (en caso de cancelaci√≥n)

#### Notificaciones Push

**Tipos de Notificaciones:**
- ‚úÖ Pedido aceptado por cafeter√≠a
- ‚úÖ Pedido en preparaci√≥n
- ‚úÖ Pedido listo para recoger (notificaci√≥n persistente)
- ‚úÖ Pedido cancelado (con raz√≥n)
- ‚úÖ Ofertas y promociones
- ‚úÖ Recordatorio de pedido no recogido
- ‚úÖ Notificaci√≥n de stock bajo (productos favoritos)

**Centro de Notificaciones:**
- ‚úÖ Ver historial de todas las notificaciones
- ‚úÖ Marcar como le√≠do/no le√≠do
- ‚úÖ Abrir notificaci√≥n ‚Üí ir a pedido correspondiente
- ‚úÖ Eliminar notificaciones (soft delete)
- ‚úÖ Badge count en icono de app

**Preferencias de Notificaciones:**
```
‚îú‚îÄ‚îÄ Pedidos
‚îÇ   ‚îú‚îÄ‚îÄ Aceptado ‚úì
‚îÇ   ‚îú‚îÄ‚îÄ En preparaci√≥n ‚óã (opcional)
‚îÇ   ‚îî‚îÄ‚îÄ Listo ‚úì
‚îú‚îÄ‚îÄ Promociones
‚îÇ   ‚îú‚îÄ‚îÄ Diarias ‚óã
‚îÇ   ‚îú‚îÄ‚îÄ Semanales ‚óã
‚îÇ   ‚îî‚îÄ‚îÄ Especiales ‚úì
‚îú‚îÄ‚îÄ Horario tranquilo
‚îÇ   ‚îú‚îÄ‚îÄ Desde: 22:00
‚îÇ   ‚îî‚îÄ‚îÄ Hasta: 08:00
‚îî‚îÄ‚îÄ Sonido y vibraci√≥n
    ‚îú‚îÄ‚îÄ Sonido ‚úì
    ‚îî‚îÄ‚îÄ Vibraci√≥n ‚úì
```

#### Historial de Pagos

- ‚úÖ Ver todas las transacciones
- ‚úÖ Filtrar por fecha, monto, estado
- ‚úÖ Descargar recibos en PDF
- ‚úÖ Reclamaci√≥n de transacciones fraudulentas
- ‚úÖ Reembolsos historio

---

### Panel Cafeter√≠a/Admin (Web)

#### Dashboard Mejorado

**Nuevos widgets:**
- ‚úÖ Ingresos del d√≠a (gr√°fico en tiempo real)
- ‚úÖ M√©todos de pago m√°s usados (gr√°fico)
- ‚úÖ Tasa de √©xito de pagos
- ‚úÖ Pedidos promedio por hora (gr√°fico)
- ‚úÖ Top 5 productos m√°s vendidos
- ‚úÖ Satisfacci√≥n de clientes (rating promedio)

**Alertas Inteligentes:**
```
üî¥ CR√çTICA: Muchos pedidos sin aceptar (> 10)
üü° ADVERTENCIA: Stock bajo de producto popular
üü¢ INFO: +20% de ingresos hoy vs promedio
```

#### Gesti√≥n de Transacciones

- ‚úÖ Ver todas las transacciones de pago
- ‚úÖ Filtrar por estado (√©xito, fall√≥, pendiente)
- ‚úÖ Ver detalles: monto, gateway, ID transacci√≥n, timestamp
- ‚úÖ Descargar reporte de transacciones (CSV, Excel)
- ‚úÖ Reconciliaci√≥n autom√°tica
- ‚úÖ Manejo de reembolsos (partial/total)

#### Reembolsos

- ‚úÖ Procesar reembolso por pedido cancelado
- ‚úÖ Reembolso autom√°tico (si pago con tarjeta)
- ‚úÖ O devolver saldo a wallet del usuario
- ‚úÖ Historial de reembolsos
- ‚úÖ Notificaci√≥n autom√°tica al usuario

#### Configuraci√≥n de Pagos

- ‚úÖ Habilitaci√≥n de m√©todos de pago
- ‚úÖ Comisi√≥n por transacci√≥n (configurable)
- ‚úÖ L√≠mites de transacci√≥n
- ‚úÖ Horarios de pago habilitados

#### Auditor√≠a de Transacciones

- ‚úÖ Log completo de cada transacci√≥n
- ‚úÖ IP origen, dispositivo, usuario
- ‚úÖ Timestamp exacto
- ‚úÖ Respuesta del gateway
- ‚úÖ Estado final de la transacci√≥n

---

### Sistema (Backend)

#### Integraci√≥n de Pagos - Stripe

```typescript
// Backend: Stripe Service
import Stripe from 'stripe';

class PaymentService {
  private stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

  // Crear token de pago
  async createPaymentMethod(cardData) {
    return this.stripe.paymentMethods.create({
      type: 'card',
      card: cardData
    });
  }

  // Procesar pago
  async createPaymentIntent(orderId: string, amount: number) {
    const paymentIntent = await this.stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // en centavos
      currency: 'mxn',
      metadata: { orderId }
    });
    return paymentIntent;
  }

  // Confirmar pago
  async confirmPayment(paymentIntentId: string, paymentMethodId: string) {
    return this.stripe.paymentIntents.confirm(paymentIntentId, {
      payment_method: paymentMethodId
    });
  }

  // Procesar reembolso
  async refundPayment(paymentIntentId: string, amount?: number) {
    return this.stripe.refunds.create({
      payment_intent: paymentIntentId,
      amount: amount ? Math.round(amount * 100) : undefined
    });
  }
}
```

#### Integraci√≥n de Pagos - MercadoPago

```typescript
class MercadoPagoService {
  private mercadopago = require('mercadopago');

  async createPreference(orderId: string, items: any[]) {
    const preference = {
      items: items.map(item => ({
        title: item.name,
        unit_price: item.price,
        quantity: item.quantity
      })),
      back_urls: {
        success: `${process.env.APP_URL}/payment/success`,
        failure: `${process.env.APP_URL}/payment/failure`,
        pending: `${process.env.APP_URL}/payment/pending`
      },
      metadata: { orderId }
    };

    return this.mercadopago.preferences.create(preference);
  }

  async handleWebhook(data: any) {
    // Procesar confirmaci√≥n de pago
  }
}
```

#### Endpoints de Pago

```
POST   /api/payments/methods                    - Guardar tarjeta
GET    /api/payments/methods                    - Listar tarjetas guardadas
DELETE /api/payments/methods/:id                - Eliminar tarjeta
POST   /api/payments/intent                     - Crear intenci√≥n de pago
POST   /api/payments/confirm                    - Confirmar pago
GET    /api/payments/transactions               - Ver transacciones
POST   /api/payments/refund                     - Procesar reembolso
POST   /api/payments/wallet/topup               - Recargar wallet
GET    /api/payments/wallet/balance             - Ver saldo wallet
POST   /api/payments/webhook/stripe             - Webhook de Stripe
POST   /api/payments/webhook/mercadopago        - Webhook de MercadoPago
```

#### Sistema de Notificaciones Push

```typescript
// Notification Service
import * as admin from 'firebase-admin';

class NotificationService {
  async sendPushNotification(userId: string, payload: {
    title: string;
    body: string;
    data?: Record<string, string>;
  }) {
    const user = await this.usersService.findOne(userId);
    
    if (!user.fcmToken) return;

    const message = {
      notification: {
        title: payload.title,
        body: payload.body
      },
      data: payload.data || {},
      android: {
        priority: 'high',
        ttl: 3600
      },
      apns: {
        headers: {
          'apns-priority': '10'
        }
      }
    };

    try {
      await admin.messaging().send({
        ...message,
        token: user.fcmToken
      });

      // Guardar en DB para historial
      await this.notificationsRepository.create({
        userId,
        type: payload.data?.type,
        title: payload.title,
        body: payload.body
      });
    } catch (error) {
      console.error('Error sending notification:', error);
    }
  }

  async sendToTopic(topic: string, payload: any) {
    return admin.messaging().send({
      ...payload,
      topic
    });
  }

  // Notificaci√≥n de pedido aceptado
  async notifyOrderAccepted(orderId: string) {
    const order = await this.ordersService.findOne(orderId);
    await this.sendPushNotification(order.userId, {
      title: '¬°Tu pedido ha sido aceptado!',
      body: `Tu orden #${orderId.slice(-6)} est√° en preparaci√≥n`,
      data: {
        type: 'ORDER_ACCEPTED',
        orderId,
        action: 'OPEN_ORDER'
      }
    });
  }

  // Notificaci√≥n de pedido listo (persistente)
  async notifyOrderReady(orderId: string) {
    const order = await this.ordersService.findOne(orderId);
    await this.sendPushNotification(order.userId, {
      title: '¬°Tu pedido est√° listo!',
      body: `Tu orden #${orderId.slice(-6)} est√° lista para recoger en cafeter√≠a`,
      data: {
        type: 'ORDER_READY',
        orderId,
        priority: 'HIGH',
        action: 'OPEN_ORDER'
      }
    });

    // Enviar nuevamente despu√©s de 5 minutos si no ha sido recogido
    await this.scheduleReminderNotification(orderId, 5);
  }

  // Notificaci√≥n de promoci√≥n segmentada
  async sendPromotion(segment: 'TOP_BUYERS' | 'INACTIVE' | 'ALL', promo: {
    title: string;
    body: string;
    code?: string;
  }) {
    let userIds: string[] = [];

    if (segment === 'TOP_BUYERS') {
      // Top 10% de usuarios por ingresos generados
      userIds = await this.getUsersBySegment('TOP_BUYERS');
    } else if (segment === 'INACTIVE') {
      // Usuarios que no han pedido en 7 d√≠as
      userIds = await this.getUsersBySegment('INACTIVE');
    } else {
      // Todos
      userIds = await this.getAllUserIds();
    }

    for (const userId of userIds) {
      await this.sendPushNotification(userId, promo);
    }
  }
}
```

#### Webhook de Pagos

```typescript
@Post('/webhook/stripe')
async handleStripeWebhook(
  @Body() event: any,
  @Headers('stripe-signature') signature: string
) {
  // Validar firma del webhook
  const stripeEvent = this.paymentService.verifyStripeSignature(
    event,
    signature
  );

  switch (stripeEvent.type) {
    case 'payment_intent.succeeded':
      await this.handlePaymentSuccess(stripeEvent.data.object);
      break;
    case 'payment_intent.payment_failed':
      await this.handlePaymentFailure(stripeEvent.data.object);
      break;
    case 'charge.refunded':
      await this.handleRefund(stripeEvent.data.object);
      break;
  }

  return { received: true };
}
```

---

## üèóÔ∏è Arquitectura T√©cnica (v2)

### Nuevos Componentes

#### Payment Gateway Abstraction
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    App/Admin Panel              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇAPI Backend ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Payment Service Layer     ‚îÇ
        ‚îÇ  (Interface com√∫n)          ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stripe ‚îÇ        ‚îÇMercadoPago‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Firebase Cloud Messaging (FCM)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Backend    ‚îÇ
‚îÇ  NestJS      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ Firebase Admin SDK
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Firebase Cloud  ‚îÇ
‚îÇ   Messaging      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ          ‚îÇ
   ‚ñº          ‚ñº
 iOS       Android
```

### Base de Datos - Nuevas Tablas

```sql
-- M√©todos de Pago
CREATE TABLE payment_methods (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  type ENUM ('CARD', 'WALLET', 'ACCOUNT') NOT NULL,
  card_last_four VARCHAR,
  card_brand VARCHAR,
  is_default BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  stripe_payment_method_id VARCHAR UNIQUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Transacciones
CREATE TABLE transactions (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  user_id UUID REFERENCES users(id),
  amount DECIMAL(10,2) NOT NULL,
  currency VARCHAR DEFAULT 'MXN',
  payment_gateway ENUM ('STRIPE', 'MERCADO_PAGO', 'WALLET') NOT NULL,
  gateway_transaction_id VARCHAR UNIQUE,
  status ENUM ('PENDING', 'SUCCESS', 'FAILED', 'REFUNDED') NOT NULL,
  payment_method_id UUID REFERENCES payment_methods(id),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Wallet de Usuario
CREATE TABLE user_wallets (
  id UUID PRIMARY KEY,
  user_id UUID UNIQUE REFERENCES users(id),
  balance DECIMAL(10,2) DEFAULT 0,
  currency VARCHAR DEFAULT 'MXN',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Transacciones de Wallet
CREATE TABLE wallet_transactions (
  id UUID PRIMARY KEY,
  wallet_id UUID REFERENCES user_wallets(id),
  type ENUM ('TOPUP', 'PURCHASE', 'REFUND', 'ADMIN_ADJUSTMENT') NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  balance_before DECIMAL(10,2),
  balance_after DECIMAL(10,2),
  description VARCHAR,
  related_order_id UUID REFERENCES orders(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Notificaciones
CREATE TABLE notifications (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  type ENUM ('ORDER_ACCEPTED', 'ORDER_PREPARING', 'ORDER_READY', 
             'ORDER_CANCELLED', 'PAYMENT_SUCCESS', 'PAYMENT_FAILED',
             'PROMOTION', 'REMINDER', 'SYSTEM') NOT NULL,
  title VARCHAR NOT NULL,
  body TEXT NOT NULL,
  data JSONB,
  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- FCM Tokens
CREATE TABLE fcm_tokens (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  token VARCHAR UNIQUE NOT NULL,
  device_type ENUM ('IOS', 'ANDROID', 'WEB') NOT NULL,
  device_model VARCHAR,
  os_version VARCHAR,
  app_version VARCHAR,
  is_active BOOLEAN DEFAULT TRUE,
  last_used TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### Dependencies Nuevas

```json
{
  "@stripe/stripe-js": "^1.46.0",
  "stripe": "^14.0.0",
  "mercadopago": "^2.0.0",
  "firebase-admin": "^12.0.0",
  "node-fetch": "^3.3.2",
  "bull": "^4.11.5"
}
```

---

## üîê Seguridad en v2

### PCI-DSS Compliance

**Level 1 Compliance** (para instituciones con 6M+ transacciones/a√±o):
- ‚úÖ Tokenizaci√≥n de tarjetas (nunca almacenar datos raw)
- ‚úÖ Encriptaci√≥n de datos en tr√°nsito (TLS 1.2+)
- ‚úÖ Encriptaci√≥n de datos en reposo
- ‚úÖ Autenticaci√≥n fuerte (JWT + 2FA para admin)
- ‚úÖ Control de acceso basado en roles
- ‚úÖ Firewalls y sistemas de detecci√≥n de intrusos
- ‚úÖ Validaci√≥n de input y output
- ‚úÖ Auditor√≠a y logging completo

**Implementaci√≥n:**
```typescript
// Nunca guardar datos de tarjeta
‚ùå card_number
‚ùå cvv
‚ùå expiration_date

‚úÖ stripe_payment_method_id (tokenizado)
‚úÖ card_last_four: "4242"
‚úÖ card_brand: "VISA"
```

### Webhook Security

```typescript
// Validar firma de webhook
const sig = req.headers['stripe-signature'];
const body = req.rawBody;

try {
  const event = stripe.webhooks.constructEvent(
    body,
    sig,
    process.env.STRIPE_WEBHOOK_SECRET
  );
} catch (err) {
  return res.status(400).send(`Webhook Error: ${err.message}`);
}
```

### Rate Limiting de Pagos

```typescript
// Limitar intentos de pago
const paymentRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 10, // m√°ximo 10 intentos
  keyGenerator: (req) => req.user.id
});

@UseGuards(JwtAuthGuard)
@Post('/payments/confirm')
@UseInterceptors(paymentRateLimiter)
confirmPayment() { ... }
```

### Detecci√≥n de Fraude

```typescript
// An√°lisis de transacci√≥n sospechosa
async detectFraud(transaction: Transaction): Promise<boolean> {
  const user = await this.usersService.findOne(transaction.userId);

  // 1. Monto anormalmente alto
  if (transaction.amount > user.avgOrderValue * 3) return true;

  // 2. M√∫ltiples transacciones fallidas
  const recentFailures = await this.transactionsRepository.count({
    where: {
      user_id: transaction.userId,
      status: 'FAILED',
      created_at: { $gte: new Date(Date.now() - 3600000) } // √∫ltima hora
    }
  });
  if (recentFailures > 5) return true;

  // 3. Localizaci√≥n geogr√°fica sospechosa
  const lastLocation = user.lastLocation;
  const currentLocation = transaction.ipLocation;
  if (this.calculateDistance(lastLocation, currentLocation) > 5000) {
    // Cambio de m√°s de 5000 km en 1 minuto = imposible
    return true;
  }

  return false;
}

// Si se detecta fraude
async handleFraudDetected(transaction: Transaction) {
  await this.transactionsRepository.update(transaction.id, {
    status: 'FRAUD_DETECTED'
  });

  await this.notificationService.notifyAdmin(
    `‚ö†Ô∏è Fraude detectado: Usuario ${transaction.userId}, Monto: $${transaction.amount}`
  );

  // Marcar transacci√≥n para revisi√≥n manual
  await this.auditService.flag(transaction.id, 'MANUAL_REVIEW_REQUIRED');
}
```

### Encriptaci√≥n de Datos Sensibles

```typescript
import * as crypto from 'crypto';

const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY;

class EncryptionService {
  encrypt(data: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv('aes-256-cbc', Buffer.from(ENCRYPTION_KEY), iv);
    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    return `${iv.toString('hex')}:${encrypted}`;
  }

  decrypt(encrypted: string): string {
    const [iv, data] = encrypted.split(':');
    const decipher = crypto.createDecipheriv(
      'aes-256-cbc',
      Buffer.from(ENCRYPTION_KEY),
      Buffer.from(iv, 'hex')
    );
    let decrypted = decipher.update(data, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  }
}
```

---

## üé® UX/UI en v2

### Flujo: Primera Compra con Tarjeta

```
1. Usuario llega a checkout
   ‚Üì
2. Selecciona "Pagar con tarjeta"
   ‚Üì
3. Opci√≥n: "Agregar nueva tarjeta" o seleccionar guardada
   ‚Üì
4. Abre formulario seguro de Stripe
   (No pasa por servidor de la app)
   ‚Üì
5. Ingresa datos:
   - N√∫mero 16 d√≠gitos (validaci√≥n en tiempo real)
   - Expiry MM/YY
   - CVV 3 d√≠gitos
   - Nombre del titular
   ‚Üì
6. Stripe retorna token
   ‚Üì
7. App env√≠a token al backend
   ‚Üì
8. Backend crea PaymentIntent con Stripe
   ‚Üì
9. Transacci√≥n procesa (loader animado)
   ‚Üì
10. ‚úÖ √âxito:
    - Orden confirmada
    - Recibir notificaci√≥n push
    - Ver resumen con recibo
    
    ‚ùå Fallo:
    - Mostrar error espec√≠fico
    - Opci√≥n de reintentar
    - Contactar soporte
```

### Notificaciones - Dise√±o Visual

**Notificaci√≥n Push (IOS):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ITSUR Eats            14:30   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üü¢ ¬°Tu pedido est√° listo!   ‚îÇ
‚îÇ Orden #A2B1C5 lista para      ‚îÇ
‚îÇ recoger en cafeter√≠a          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üîî Abrir app                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Notificaci√≥n In-App:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úì  Pago exitoso                ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  Transacci√≥n: $45.50 MXN       ‚îÇ
‚îÇ  Orden: #A2B1C5                ‚îÇ
‚îÇ  M√©todo: Visa ‚Ä¢‚Ä¢‚Ä¢‚Ä¢4242         ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [Ver Recibo]  [Seguir Pedido] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dashboard de Pagos (Admin)

**Secci√≥n de Transacciones:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Transacciones Hoy                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Total: $2,450.50 | 34 transacciones       ‚îÇ
‚îÇ √âxito: 33 (97%) | Fallos: 1 (3%)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Tabla:                                     ‚îÇ
‚îÇ [Hora] [Usuario] [Monto] [M√©todo] [Estado]
‚îÇ 14:30  Juan P.   $45.50  Visa    ‚úÖ      ‚îÇ
‚îÇ 14:25  Mar√≠a G.  $65.00  WALLET  ‚úÖ      ‚îÇ
‚îÇ 14:15  Carlos V. $32.75  Tarjeta ‚ùå      ‚îÇ
‚îÇ ...                                        ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ [Descargar CSV] [Descargar Excel]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Wallet - Interfaz

**Vista de Saldo:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Wallet ITSUR       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saldo Disponible      ‚îÇ
‚îÇ      $450.75 MXN        ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ   [Recargar Saldo +]    ‚îÇ
‚îÇ   [Ver Historial]       ‚îÇ
‚îÇ   [Cambiar Pago]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Recarga de Saldo:**
```
1. Usuario toca "Recargar Saldo"
   ‚Üì
2. Ingresa monto ($100-$5,000)
   ‚Üì
3. Selecciona m√©todo de pago
   ‚Üì
4. Confirma transacci√≥n
   ‚Üì
5. Notificaci√≥n de √©xito
   ‚Üì
6. Saldo se actualiza inmediatamente
```

---

## üöÄ Preparaci√≥n para Producci√≥n en v2

### Certificados de Seguridad

```bash
# Certificados Stripe (obtener en dashboard)
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Certificados MercadoPago
MERCADO_PAGO_ACCESS_TOKEN=APP_USR-...
MERCADO_PAGO_WEBHOOK_SECRET=...

# Firebase
FIREBASE_PROJECT_ID=itsur-eats
FIREBASE_PRIVATE_KEY=...
```

### Monitoreo de Pagos

```
üîç M√©tricas Cr√≠ticas:
- Payment success rate (target: > 95%)
- Average transaction time (target: < 3 sec)
- Failed transaction rate by gateway
- Fraud detection rate
- Refund processing time
- Gateway uptime
```

**Alertas Autom√°ticas:**
```
üî¥ CR√çTICA: Payment success rate < 80%
üü° ADVERTENCIA: 10+ pagos fallidos en 5 minutos
üî¥ CR√çTICA: Stripe API unavailable
üî¥ CR√çTICA: Fraude detectado (> 5 intentos fallidos)
```

### Testing de Pagos

**Tarjetas de prueba Stripe:**
```
√âxito: 4242 4242 4242 4242
Fallo: 4000 0000 0000 0002
3D Secure: 4000 0025 0000 3010
```

**E2E Test:**
```typescript
describe('Payment Flow', () => {
  it('should successfully complete payment with card', async () => {
    // 1. Create order
    const order = await api.post('/orders', orderData);
    
    // 2. Create payment intent
    const intent = await api.post('/payments/intent', {
      orderId: order.id,
      amount: order.total
    });
    
    // 3. Confirm payment with test card
    const payment = await api.post('/payments/confirm', {
      intentId: intent.id,
      paymentMethodId: testCardToken
    });
    
    // 4. Verify order status updated
    const updatedOrder = await api.get(`/orders/${order.id}`);
    expect(updatedOrder.paymentStatus).toBe('COMPLETED');
    expect(updatedOrder.status).toBe('ACCEPTED');
  });
});
```

---

## üìä KPIs & √âxito de v2

| KPI | Meta | M√©trica |
|-----|------|---------|
| Payment Success Rate | > 95% | Pagos exitosos / Total |
| Avg Payment Time | < 3s | Tiempo de procesamiento |
| Fraud Detection Rate | < 0.5% | Transacciones fraudulentas |
| User Adoption (Wallet) | > 40% | Usuarios con wallet cargado |
| Notification Open Rate | > 60% | Notificaciones abiertas |
| Conversion Rate | > 80% | Usuarios que completan compra |
| Monthly Recurring Revenue | $10K | Ingresos mensuales |

---

## üîÑ Testing en v2

### Pruebas de Pago

```bash
# Unit tests
npm run test -- payment.service.spec.ts

# Integration tests
npm run test:e2e -- payment.e2e.spec.ts

# Load tests (simular 1000 usuarios simult√°neos)
npm run load-test -- --users 1000
```

**Coverage target:** 80%

---

## üìÖ Timeline de v2

| Semana | Hito |
|--------|------|
| 1-2 | Setup Stripe/MercadoPago, database schema |
| 3-4 | Payment service backend, webhook handling |
| 5-6 | Mobile payment UI, Stripe JS integration |
| 7 | FCM setup, notification system |
| 8 | Testing, security audit, go-live |

---

## üìù Entregables de v2

```
‚úÖ Backend
   - Payment service integrado
   - Webhook handlers
   - Notification system
   - Fraud detection

‚úÖ Mobile
   - Payment UI
   - Wallet management
   - Notification center
   - Receipt download

‚úÖ Admin Panel
   - Transaction management
   - Refund processing
   - Payment analytics

‚úÖ Seguridad
   - PCI-DSS compliance report
   - Security audit
   - Encryption implementation

‚úÖ Documentaci√≥n
   - Payment API docs
   - Integration guides
   - Security best practices
```

---

## üìå Siguiente Fase (v3.0.0)

‚Üí **v3.0.0 ‚Äî Scalability & Performance**

Con 2,000+ usuarios activos y transacciones reales:
- Caching avanzado (Redis distributed)
- Database optimization y replicaci√≥n
- Real-time updates con WebSockets optimizados
- CDN global para contenido est√°tico
- Auto-scaling infrastructure

**Estimado**: 6 semanas despu√©s de v2

---

**Documento creado**: 20 Enero 2026
**Estado**: Especificaci√≥n T√©cnica Completa
**Aprobado por**: Arquitectura de Software
